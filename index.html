<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D3_PWSH_TITLE</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.1/styles/default.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/beercss@3.7.8/dist/cdn/beer.min.css" rel="stylesheet">
  <style>
    body { margin: 0 }
    .tooltip { opacity: 1 !important; }
  </style>
</head>
<body>
  <div id="app">
    <main>
      <div id='spinner-overlay' class="overlay" style="z-index: 10002"></div>
      <div id='blurred-overlay' class="overlay blur"></div>
      
      <dialog id="dialog-custom-overlay" class="max">
        <h5>Select File</h5>
        <div class="margin-bottom">
          <article id="fileListExpansions" class="border no-padding">
          </article>
        </div>
        <nav class="right-align no-space">
          <button class="transparent link" data-ui="#dialog-custom-overlay">Cancel</button>
        </nav>
      </dialog>

      <div id="chart"></div>

      <div class="fixed top right margin">
          <button data-ui="#dialog-custom-overlay" class="">Choose File</button>
      </div>
    </main>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/page-js@1.7.3/page.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.4.1/highlight.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.7.8/dist/cdn/beer.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/material-dynamic-colors@1.1.2/dist/cdn/material-dynamic-colors.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>

      // the resources.json json file contains the list of resources to load must be formatted as follows:
      // [
      //   {
      //     "name": "Resource Name",
      //     "category": "Category Name",
      //     "count" : 2,
      //     "url": "path/to/resource.json"
      //   }
      // ]

      var resourcesFile = 'resources.json';    document.addEventListener('DOMContentLoaded', function() {
        var blurredOverlay = document.getElementById('blurred-overlay');
        var spinnerOverlay = document.getElementById('spinner-overlay');
        var dialog = document.getElementById('dialog-custom-overlay');
        
        // Create a progress spinner with BeerCSS and Material Design Icons
        var loadingOverlay = document.createElement('div');
        loadingOverlay.style.position = 'fixed';
        loadingOverlay.style.top = '0';
        loadingOverlay.style.left = '0';
        loadingOverlay.style.width = '100%';
        loadingOverlay.style.height = '100%';
        loadingOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        loadingOverlay.style.display = 'flex';
        loadingOverlay.style.justifyContent = 'center';
        loadingOverlay.style.alignItems = 'center';
        loadingOverlay.style.zIndex = '10001';

        var loading = document.createElement('progress');
        loading.className = 'circle large';

        loadingOverlay.appendChild(loading);
        spinnerOverlay.appendChild(loadingOverlay);
        
        fetch(resourcesFile)
            .then(res => res.json())
            .then(data => {
                console.log("resources data loaded:", data);
                var fileListExpansions = document.getElementById('fileListExpansions');
                var categories = {};

                // Group resources by category
                data.forEach(function(item) {
                    if (!categories[item.category]) {
                        categories[item.category] = [];
                    }
                    categories[item.category].push(item);
                });

                // Create menu structure
                for (var category in categories) {
                    var details = document.createElement('details');
                    var summary = document.createElement('summary');
                    summary.className = 'none';
                    summary.innerHTML = `<a class="row wave">${category}</a>`;
                    details.appendChild(summary);

                    categories[category].forEach(function(item) {
                        var article = document.createElement('article');
                        article.className = 'border round margin';

                        var divRow = document.createElement('div');
                        divRow.className = 'row';

                        var divMax = document.createElement('div');
                        divMax.className = 'max';

                        var h5 = document.createElement('h5');
                        h5.textContent = item.name;

                        var p = document.createElement('p');
                        // transform the count to a human readable format
                        // replace 001 with 1, 002 with 2, etc.
                        var count = item.count.replace(/0+(\d+)/, '$1');
                        p.textContent = `Number of Modules: ${count}`;

                        divMax.appendChild(h5);
                        divMax.appendChild(p);
                        divRow.appendChild(divMax);
                        article.appendChild(divRow);

                        var nav = document.createElement('nav');
                        var button = document.createElement('button');
                        button.textContent = 'Open';
                        button.onclick = function(event) {
                            event.preventDefault();
                            spinnerOverlay.classList.add('active');

                            var jsonFilePath = item.url;
                            
                            var existingSunburst = document.getElementById('chart');
                            // Remove the previous sunburst chart if it exists
                            if (existingSunburst) {
                                while (existingSunburst.firstChild) {
                                    existingSunburst.removeChild(existingSunburst.firstChild);
                                }
                            }
                            
                            fetch(jsonFilePath)
                                .then(res => res.json())
                                .then(data => {
                                    console.log("data loaded:", data);
                                    createSunburstChart(data);
                                    // add 500 ms delay to show the spinner
                                    setTimeout(() => {
                                        spinnerOverlay.classList.remove('active');
                                        console.log("Spinner removed from the document body");
                                        blurredOverlay.classList.remove('active');
                                        dialog.classList.remove('active');
                                        dialog.close();
                                        console.log("dialog closed");
                                    }, 500);
                                })
                                .catch(err => {
                                    console.error("Error loading resource data:", err);
                                    setTimeout(() => {
                                        spinnerOverlay.classList.remove('active');
                                        console.log("Spinner removed from the document body");
                                        blurredOverlay.classList.remove('active');
                                        dialog.classList.remove('active');
                                        dialog.close();
                                        console.log("dialog closed");
                                    }, 500);
                                });
                        };

                        nav.appendChild(button);
                        article.appendChild(nav);
                        details.appendChild(article);
                    });

                    fileListExpansions.appendChild(details);

                }

                dialog.showModal();
            })
            .catch(err => console.error("Error loading resources file:", err));
      });
      
      function createSunburstChart(data) {
        
        const width =  window.innerWidth, // document.documentElement.scrollWidth - 20,
          height = window.innerHeight - 5,
          centerX = width/2,
          centerY = height/2;
        
        var startAngle = 0, // the starting angle for the sunburst
            endAngle = 2 * Math.PI, // the ending angle for the sunburst
            radius = Math.min(width, height)/2,
            padRadius = radius/4;

        // Create the color scale.
        const color = d3.scaleOrdinal(d3.quantize(d3.interpolateSinebow, data.children.length + 1));

        // Compute the layout.
        const hierarchy = d3.hierarchy(data)
                            .each(function (d) { 
                              if (d.depth && d.depth > 0 && d.parent && d.parent.value && d.parent.children) {
                                  d.value = d.parent.value/d.parent.children.length;
                              } else {
                                d.value = 100;
                              }
                            })
                            .sort((a,b) => a.data.name.localeCompare(b.data.name));
            
        const root = d3.partition()
                      .size([endAngle - startAngle, hierarchy.height + 2])
                      (hierarchy);
          
        root.each(d => d.current = d);

        // Create the arc generator.
        const arc = d3.arc()
                      .startAngle(d => d.x0 + startAngle)
                      .endAngle(d => d.x1 + startAngle)
                      .padAngle(d => Math.min((d.x1 - d.x0) / 2, 0.005))
                      .padRadius(padRadius)
                      .innerRadius(d => radius/6)
                      .outerRadius(d => radius);

        // Create the SVG container.
        const svg = d3.select("#chart")
                      .append("svg")
                        .attr("class", "node-container")
                        .attr("viewBox", [-width/2, - height/2, width, height])
                    .attr("width", width)
                    .attr("height", height)
                        .attr("font-family", "Segoe UI, Noto Sans, Helvetica, Arial, sans-serif")
                        .attr("font-size", 12);

        const format = d3.format(",d");
        
        // Append the arcs.
        const path = svg.append("g")
                        .selectAll("path")
                        .data(root.descendants().slice(1))
                        .join("path")
                          .attr("class", "node-path")
                          .attr("fill", d => { while (d.depth > 1) d = d.parent; return color(d.data.name); })
                    .attr("fill-rule", "evenodd")
                          .attr("fill-opacity", d => arcVisible(d.current) ? 0.5 : 0)
                          .attr("pointer-events", d => arcVisible(d.current) ? "auto" : "none")
                          .attr("d", d => arc(d.current));

        // Make them clickable if they have children.
        path//.filter(d => d.children)
            .style("cursor", "pointer")
            .on("click", clicked)
            .on("mouseenter", (event, el) => {
              event.target.setAttribute("stroke", event.target.getAttribute("fill"));
              event.target.setAttribute("stroke-width", 4);
              event.target.setAttribute("fill-opacity", 1.0);
            })
            .on("mouseover", (event, el) => {
              event.target.setAttribute("stroke", event.target.getAttribute("fill"));
              event.target.setAttribute("stroke-width", 4);
              event.target.setAttribute("fill-opacity", 1.0);
            })
            .on("mouseleave", (event, el) => {
              event.target.setAttribute("stroke", "transparent");
              event.target.setAttribute("stroke-width", 0);
              event.target.setAttribute("fill-opacity", 0.5);
            })
            .on("mouseout", (event, el) => {
              event.target.setAttribute("stroke", "transparent");
              event.target.setAttribute("stroke-width", 0);
              event.target.setAttribute("fill-opacity", 0.5);
            });

        path.append("title")
            .text(function(d) {
              var ancestors = d.ancestors().filter(d => d.depth > 0 && d.depth != 2);
              var text = ancestors.map(d => d.data.name).reverse().join("\\");
              return text; 
          });

        const label = svg.append("g")
                        .attr("class", "node-label")
                        .attr("pointer-events", "none")
                        .style("user-select", "none")
                        .style("fill", "#333")
                        .selectAll("text")
                        .data(root.descendants().slice(1))
                        .join("text")
                          .attr("class", "node-text")
                          .attr("fill-opacity", d => +labelVisible(d.current))
                          .attr("font-size", d => d.parent.children.length < 0 ? '12' : '10' )
                          .attr("font-weight", d => d.parent.children.length < 0 ? 'bold' : 'normal' )
                          .attr("text-anchor", d => labelAnchor(d))
                          .attr("dx", d => labelDx(d))
                          .attr("dy", d => labelDy(d))
                          .attr("transform", d => labelTransform(d))
                          .text(d => d.data.name);

        const parent = svg.append("circle")
                          .datum(root)
                          .attr("class", "node-parent")
                          .attr("r", radius/6 - 5)
                          .attr("fill", "#CCC")
                          .attr("fill-opacity", 0.5)
                          .on("mouseenter", (event, el) => {
                            event.target.setAttribute("fill-opacity", 1.0);
                            event.target.setAttribute("stroke", "#BBB");
                            event.target.setAttribute("stroke-width", 1);
                          })
                          .on("mouseout", (event, el) => {
                            event.target.setAttribute("fill-opacity", 0.5);
                            event.target.setAttribute("stroke", "transparent");
                            event.target.setAttribute("stroke-width", 1);
                          })
                          .attr("pointer-events", "all")
                          .on("click", clicked);

        console.log("Data:", data);
        console.log("Hierarchy:", hierarchy);
        console.log("Root:", root);

        // Handle zoom on click.
        function clicked(event, p) {
          
          parent.datum(p.parent || root);

          root.each(d => d.target = {
            x0: Math.max(0, Math.min(1, (d.x0 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
            x1: Math.max(0, Math.min(1, (d.x1 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
            y0: Math.max(0, d.y0 - p.depth),
            y1: Math.max(0, d.y1 - p.depth)
          });

          const t = svg.transition().duration(750);

          // Transition the data on all arcs, even the ones that arenâ€™t visible,
          // so that if this transition is interrupted, entering arcs will start
          // the next transition from the desired position.
          path.transition(t)
              .tween("data", d => {
                const i = d3.interpolate(d.current, d.target);
                return t => d.current = i(t);
              })
              .filter(function(d) {
                return +this.getAttribute("fill-opacity") || arcVisible(d.target);
              })
              .attr("fill-opacity", d => arcVisible(d.target) ? 0.5 : 0)
              .attr("pointer-events", d => arcVisible(d.target) ? "auto" : "none")
              .attrTween("d", d => () => arc(d.current));

          label.filter(function(d) {
                return +this.getAttribute("fill-opacity") || +labelVisible(d.target);
                })
              .transition(t)
              .attr("fill-opacity", d => +labelVisible(d.target))
              .attr("text-anchor", d => labelAnchor(d))
              .attr("dx", d => labelDx(d))
              .attr("dy", d => labelDy(d))
              .attrTween("transform", d => () => labelTransform(d.target));
        }
        
        function arcHover(event, p) {
        }

        function arcVisible(d) {
          return d.y1 <= 3 && d.y0 >= 1 && d.x1 > d.x0;
        }

        function labelVisible(d) {
          return d.y1 <= 3 && d.y0 >= 1 && (d.y1 - d.y0) * (d.x1 - d.x0) > 0.03;
        }

        function labelAnchor(d) {
          if (d.target) {
              var x = ((d.target.x0 + d.target.x1) / 2 * 180 / Math.PI);
          } else {
              var x = ((d.x0 + d.x1) / 2 * 180 / Math.PI);
          }
          if (x >= 180 && x <= 360) {
            return `start`;
          } else if (x >= 0 && x < 180) {
              return `end`;
          }
        }
        
        function labelDy(d) {
          var dy = 0;
          const y = (d.y0 + d.y1) / 6 * radius;
          if (y >= 180 && y <= 360) {
              return `-${dy}em`;
          } else if (y >= 0 && y < 180) {
              return `${dy}em`;
          }
        }

        function labelDx(d) {
          var dx = 0;
          if (d.depth === 1) {
            dx = 11.5;
          } else if (d.depth === 2) {
            dx = 8.5;
          } else {
            dx = 5.5;
          }
          if (d.target) {
              var x = ((d.target.x0 + d.target.x1) / 2 * 180 / Math.PI);
          } else {
              var x = ((d.x0 + d.x1) / 2 * 180 / Math.PI);
          }
          if (x >= 180 && x <= 360) {
              return `-${dx}em`;
          } else if (x >= 0 && x < 180) {
              return `${dx}em`;
          }
        }

        function labelTransform(d) {
          if (d.target) {
              var x = ((d.target.x0 + d.target.x1) / 2 * 180 / Math.PI);
              var y = (d.target.y0 + d.target.y1) / 6 * radius;
          } else {
              var x = ((d.x0 + d.x1) / 2 * 180 / Math.PI);
              var y = (d.y0 + d.y1) / 6 * radius;
          }
          return `rotate(${x - 90}) translate(${y}, 0) rotate(${x < 180 ? 0 : 180})`;
        }
      }

      
  </script>
</body>
</html>